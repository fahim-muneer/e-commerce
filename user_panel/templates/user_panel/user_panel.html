{% extends "adminbase.html" %}
{% block title %} Users {% endblock title %}
{% block heading %} Users {% endblock heading %}

{% block context %}
{% load static %}

<body class="bg-gray-50 p-4 sm:p-8">

<div class="bg-white rounded-lg shadow-xl p-8 max-w-5xl w-full mx-auto my-8">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-gray-800">Users List</h1>
        <div class="flex items-center space-x-2 w-full sm:w-1/3 md:w-1/4">
            <!-- Search form -->
            <form method="get" action="{% url 'user_panel' %}" class="relative flex-1">
                <input type="text" id="searchInput" name="q" value="{{ request.GET.q }}" placeholder="Search here..." class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 pl-10 pr-4 py-2 text-sm">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.145l4.145 4.145a.5.5 0 01-.707.707l-4.145-4.145A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                </div>
            </form>
            <!-- Clear button -->
            <a href="{% url 'user_panel' %}" id="clearSearch" class="px-3 py-2 bg-gray-500 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors duration-200 {% if not request.GET.q %}opacity-50 cursor-not-allowed{% endif %}" 
               {% if not request.GET.q %}onclick="return false;"{% endif %}>
                Clear
            </a>
        </div>
    </div>
    
    <!-- Delete form - wraps the entire table -->
    <form method="post" action="{% url 'delete_user' %}" id="deleteForm">
        {% csrf_token %}

        <!-- Table Actions -->
        <div class="flex items-center justify-between mb-4">
            <button type="submit" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow-md hover:bg-red-600 transition-colors duration-200 text-sm">
                DELETE SELECTED
            </button>
        </div>

        <!-- Table Container -->
        <div class="overflow-x-auto rounded-md border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3">
                            <p class=" py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ALL</p>
                            <input type="checkbox" id="select-all" class="h-4 w-4 text-blue-600 rounded">
                        </th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">NO.</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">USER IMAGE</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">USER FULLNAME</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">USER EMAIL</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">CREATED</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ACTION</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="userTableBody">
                    {% for person in user %}
                    <tr class="user-row">



                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" name="selected_users" value="{{ person.user.id }}" class="user-checkbox h-4 w-4 text-blue-600 rounded">
                        </td>



                        <td  class="px-6 py-4 whitespace-nowrap" >{{ forloop.counter|add:user.start_index|add:"-1" }}</td>






                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">                            
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
                                    {% if person.profile_picture %}
                                        <img src="{{ person.profile_picture.url }}" alt="User Avatar" class="h-10 w-10 rounded-full object-cover">
                                    {% else %}
                                        <svg class="h-6 w-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                        </svg>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 user-name">                            
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ person.user.full_name }}</div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 user-email">
                            <div class="flex items-center space-x-2">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                <span>{{ person.user.email }}</span>
                            </div>
                        </td>
                        
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ person.created_at }}</td>
                        
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <!-- Block/Unblock button using JavaScript to avoid nested forms -->
                            <button type="button" 
                                onclick="toggleUserStatus('{{ person.user.pk }}', {{ person.user.is_active|yesno:'true,false' }})"
                                class="px-4 py-2 {% if person.user.is_active %}bg-red-100 text-red-800 hover:bg-red-200{% else %}bg-green-100 text-green-800 hover:bg-green-200{% endif %} text-xs font-semibold rounded-full transition-colors duration-200">
                                {% if person.user.is_active %}BLOCK{% else %}UNBLOCK{% endif %}
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">No users found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- Pagination -->
            <div class="flex justify-center space-x-2 mt-8">
                {% if user.has_previous %}
                <a href="?page={{ user.previous_page_number }}" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">&lt;</a>
                {% endif %}

                {% for i in user.paginator.page_range %}
                <a href="?page={{ i }}" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">{{ i }}</a>
                {% endfor %}

                {% if user.has_next %}
                <a href="?page={{ user.next_page_number }}" class="px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100">&gt;</a>
                {% endif %}
            </div>
</div>

<!-- Hidden form for block/unblock actions -->
<form id="blockForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<script>
// Select All functionality
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.user-row');
    const clearBtn = document.getElementById('clearSearch');
    
    // Show/hide clear button based on input value
    if (this.value.trim() !== '') {
        clearBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        clearBtn.onclick = null;
    } else {
        clearBtn.classList.add('opacity-50', 'cursor-not-allowed');
        clearBtn.onclick = function() { return false; };
    }
    
    rows.forEach(row => {
        const name = row.querySelector('.user-name').textContent.toLowerCase();
        const email = row.querySelector('.user-email').textContent.toLowerCase();
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Confirmation for delete action
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one user to delete.');
        e.preventDefault();
        return;
    }
    if (!confirm(`Are you sure you want to delete ${checkedBoxes.length} user(s)?`)) {
        e.preventDefault();
    }
});

// Function to toggle user status (block/unblock)
function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'block' : 'unblock';
    if (confirm(`Are you sure you want to ${action} this user?`)) {
        const form = document.getElementById('blockForm');
        form.action = `{% url 'block_user' uid=0 %}`.replace('0', userId);
        form.submit();
    }
}
</script>

</body>

{% endblock context %}