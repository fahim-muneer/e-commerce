{% extends "adminbase.html" %}
{% load static %}

{% block title %}Order #{{ order.id }} Details{% endblock %}

{% block context %}
<div class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans antialiased">
    
    
    <div class="max-w-6xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="{% url 'order_list' %}" class="text-blue-600 hover:text-blue-800">
                        My Orders
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-gray-500 ml-1 md:ml-2">Order #{{ order.id }}</span>
                    </div>
                </li>
            </ol>
        </nav>

        <!-- Order Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Order #{{ order.id }}</h1>
                        <p class="text-gray-500 mt-1">Placed on {{ order.created_at|date:"F d, Y \a\t g:i A" }}</p>
                    </div>
                    <div class="text-right">
                        <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full 
                            {% if order.order_status == order.DELIVERED %}bg-green-100 text-green-800
                            {% elif order.order_status == order.CANCELLED %}bg-red-100 text-red-800
                            {% elif order.order_status == order.SHIPPED %}bg-blue-100 text-blue-800
                            {% else %}bg-yellow-100 text-yellow-800
                            {% endif %}">
                            {{ order.get_order_status_display }}
                        </span>
                        <div class="text-2xl font-bold text-gray-800 mt-2">₹{{ order.total_price|floatformat:2 }}</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    {% if can_cancel %}
                    <button onclick="openCancelModal()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                        Cancel Order
                    </button>
                    {% endif %}

                    {% if order.order_status == order.DELIVERED %}
                    <button onclick="reorder({{ order.id }})" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                        Reorder
                    </button>
                    {% endif %}

                    {% if can_return %}
                    <button onclick="initiateReturn()" 
                            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition duration-200">
                        Return Items
                    </button>
                    {% endif %}

                    <a href="#" 
                       class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">
                        Download Invoice
                    </a>

                    <button onclick="trackOrder({{ order.id }})" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        Track Order
                    </button>
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Timeline</h2>
                <div class="relative">
                    {% for milestone in order_timeline %}
                    <div class="flex items-center mb-4 last:mb-0">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center 
                            {% if milestone.completed %}bg-green-500{% else %}bg-gray-300{% endif %}">
                            {% if milestone.completed %}
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                            {% else %}
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                            {% endif %}
                        </div>
                        <div class="ml-4 flex-grow">
                            <div class="flex justify-between items-center">
                                <h3 class="font-medium {% if milestone.completed %}text-gray-800{% else %}text-gray-500{% endif %}">
                                    {{ milestone.status }}
                                </h3>
                                {% if milestone.date %}
                                <span class="text-sm text-gray-500">{{ milestone.date|date:"M d, Y g:i A" }}</span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-600 mt-1">{{ milestone.description }}</p>
                        </div>
                    </div>
                    {% if not forloop.last %}
                    <div class="ml-4 w-px h-6 bg-gray-300"></div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Order Items -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Items</h2>
                    
                    <div class="space-y-4">
                        {% for item in cart_items %}
                        <div class="flex items-center p-4 border border-gray-200 rounded-lg">
                            <!-- Product Image -->
                            <div class="flex-shrink-0">
                                {% if item.product.image1 %}
                                <img src="{{ item.product.image1.url }}" alt="{{ item.product.name }}" 
                                     class="h-20 w-20 rounded-lg object-cover">
                                {% else %}
                                <div class="h-20 w-20 bg-gray-200 rounded-lg flex items-center justify-center">
                                    <span class="text-gray-400 text-sm">No Image</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Product Details -->
                            <div class="flex-grow ml-4">
                                <h3 class="font-medium text-gray-800">{{ item.product.name }}</h3>
                                {% if item.product.description %}
                                <p class="text-sm text-gray-600 mt-1">{{ item.product.description|truncatechars:100 }}</p>
                                {% endif %}
                                
                                <!-- Quantity and Price -->
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex items-center">
                                        <span class="text-sm text-gray-500">Qty: </span>
                                        <span class="font-medium ml-1">{{ item.quantity }}</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-gray-800">₹{{ item.product.total_price|floatformat:2 }}</div>
                                        <div class="text-sm text-gray-500">₹{{ item.product.price|floatformat:2 }} each</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Item Actions -->
                            <div class="flex-shrink-0 ml-4">
                                <div class="flex flex-col space-y-2">
                                    <a href="{% url 'order_details' pk=item.product.pk %}" 
                                       class="text-blue-600 hover:text-blue-800 text-sm">
                                        View Product
                                    </a>
                                    {% if order.order_status == order.DELIVERED %}
                                    <button onclick="reviewProduct({{ item.product.id }})" 
                                            class="text-green-600 hover:text-green-800 text-sm">
                                        Write Review
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Order Summary & Details -->
            <div class="space-y-6">
                <!-- Pricing Breakdown -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Order Summary</h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-medium">₹{{ subtotal|floatformat:2 }}</span>
                        </div>
                        {% if discount_amount > 0 %}
                        <div class="flex justify-between text-green-600">
                            <span>Discount</span>
                            <span>-₹{{ discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-medium">₹{{ shipping_cost|floatformat:2 }}</span>
                        </div>
                        {% if tax_amount > 0 %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tax</span>
                            <span class="font-medium">₹{{ tax_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <hr class="my-3">
                        <div class="flex justify-between text-lg font-bold">
                            <span>Total</span>
                            <span>₹{{ total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>

                <!-- Delivery Information -->
                {% if order.delivery_address %}
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Delivery Address</h2>
                    
                    <div class="text-sm space-y-2">
                        <div class="font-medium">{{ customer.get_full_name|default:customer.username }}</div>
                        <div>{{ order.delivery_address.address }}</div>
                        <div>{{ order.delivery_address.city }}, {{ order.delivery_address.state }} {{ order.delivery_address.pin }}</div>
                        <div>{{ order.delivery_address.country }}</div>
                        {% if order.delivery_address.mobile %}
                        <div class="pt-2">
                            <span class="text-gray-600">Phone: </span>
                            <a href="tel:{{ order.delivery_address.mobile }}" class="text-blue-600">
                                {{ order.delivery_address.mobile }}
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Payment Information -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payment Information</h2>
                    
                    <div class="space-y-2 text-sm">
                        {% if order.payment_id %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payment ID</span>
                            <span class="font-mono">{{ order.payment_id }}</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payment Method</span>
                            <span>{{ order.payment_method|default:"Online Payment" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Payment Status</span>
                            <span class="px-2 py-1 text-xs rounded-full 
                                {% if order.payment_status == 'completed' %}bg-green-100 text-green-800
                                {% elif order.payment_status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800
                                {% endif %}">
                                {{ order.get_payment_status_display|default:"Completed" }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Order Actions -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Need Help?</h2>
                    
                    <div class="space-y-3">
                        <a href="mailto:support@yourstore.com?subject=Order #{{ order.id }}" 
                           class="block w-full text-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200">
                            Contact Support
                        </a>
                        <a href="#" 
                           class="block w-full text-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200">
                            View FAQ
                        </a>
                        <a href="#" 
                           class="block w-full text-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200">
                            Return Policy
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div id="cancelModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Cancel Order</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to cancel this order? This action cannot be undone.</p>
            
            <form method="POST" action="">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="cancellation_reason" class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for cancellation (optional)
                    </label>
                    <textarea name="reason" id="cancellation_reason" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                              placeholder="Please tell us why you're cancelling this order..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeCancelModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Keep Order
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Cancel Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
function openCancelModal() {
    document.getElementById('cancelModal').classList.remove('hidden');
}

function closeCancelModal() {
    document.getElementById('cancelModal').classList.add('hidden');
}

function reorder(orderId) {
    if (confirm('Add all items from this order to your cart?')) {
        fetch(`/orders/${orderId}/reorder/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Items added to cart successfully!');
                window.location.href = '/cart/';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

function trackOrder(orderId) {
    fetch(`/orders/${orderId}/track/`)
        .then(response => response.json())
        .then(data => {
            alert(`Order Status: ${data.status}\nLast Updated: ${new Date(data.last_updated).toLocaleString()}`);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Unable to fetch tracking information.');
        });
}

function reviewProduct(productId) {
    window.location.href = `/products/${productId}/review/`;
}

function initiateReturn() {
    alert('Return process will be implemented here. You will be redirected to the return form.');
    // Implement return logic
}

// Close modal when clicking outside
document.getElementById('cancelModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCancelModal();
    }
});
</script>
{% endblock context %}